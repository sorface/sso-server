FROM maven:3.8.7-eclipse-temurin-19 as build

COPY . .

ARG ACTIVE_PROFILE=production
ARG REACT_APP_BACKEND_URL=$REACT_APP_BACKEND_URL
ARG REACT_APP_VERSION=$REACT_APP_VERSION

RUN mvn clean package \
     -P run.context.$ACTIVE_PROFILE  \
     -P module.frontend  \
     -D REACT_APP_BACKEND_URL=$REACT_APP_BACKEND_URL  \
     -D REACT_APP_VERSION=$REACT_APP_VERSION

FROM eclipse-temurin:19

# delete the pizdec

ARG DATABASE_URL
ARG DATABASE_USERNAME
ARG DATABASE_PASSWORD

ARG MAIL_NOTIFICATOR_USERNAME
ARG MAIL_NOTIFICATOR_PASSWORD

ARG OAUTH_CLIENT_GITHUB_ID
ARG OAUTH_CLIENT_GITHUB_SECRET

ARG OAUTH_CLIENT_GOOGLE_ID
ARG OAUTH_CLIENT_GOOGLE_SECRET

ARG OAUTH_CLIENT_YANDEX_ID
ARG OAUTH_CLIENT_YANDEX_SECRET
ARG OAUTH_CLIENT_YANDEX_REDIRECT_URL

ARG OAUTH_CLIENT_TWITCH_ID
ARG OAUTH_CLIENT_TWITCH_SECRET
ARG OAUTH_CLIENT_TWITCH_REDIRECT_URL

ARG OAUTH_SERVER_ISSUER_URL

ARG REDIS_USERNAME
ARG REDIS_PASSWORD
ARG REDIS_HOST

ENV DATABASE_URL ${DATABASE_URL}
ENV DATABASE_USERNAME ${DATABASE_USERNAME}
ENV DATABASE_PASSWORD ${DATABASE_PASSWORD}

ENV MAIL_NOTIFICATOR_USERNAME ${MAIL_NOTIFICATOR_USERNAME}
ENV MAIL_NOTIFICATOR_PASSWORD ${MAIL_NOTIFICATOR_PASSWORD}

ENV OAUTH_CLIENT_GITHUB_ID ${OAUTH_CLIENT_GITHUB_ID}
ENV OAUTH_CLIENT_GITHUB_SECRET ${OAUTH_CLIENT_GITHUB_SECRET}

ENV OAUTH_CLIENT_GOOGLE_ID ${OAUTH_CLIENT_GOOGLE_ID}
ENV OAUTH_CLIENT_GOOGLE_ID ${OAUTH_CLIENT_GOOGLE_SECRET}

ENV OAUTH_CLIENT_YANDEX_ID ${OAUTH_CLIENT_YANDEX_ID}
ENV OAUTH_CLIENT_YANDEX_SECRET ${OAUTH_CLIENT_YANDEX_SECRET}
ENV OAUTH_CLIENT_YANDEX_REDIRECT_URL ${OAUTH_CLIENT_YANDEX_REDIRECT_URL}

ENV OAUTH_CLIENT_TWITCH_ID ${OAUTH_CLIENT_TWITCH_ID}
ENV OAUTH_CLIENT_TWITCH_SECRET ${OAUTH_CLIENT_TWITCH_SECRET}
ENV OAUTH_CLIENT_TWITCH_REDIRECT_URL ${OAUTH_CLIENT_TWITCH_REDIRECT_URL}

ENV OAUTH_SERVER_ISSUER_URL ${OAUTH_SERVER_ISSUER_URL}

ENV REDIS_USERNAME ${REDIS_USERNAME}
ENV REDIS_PASSWORD ${REDIS_PASSWORD}
ENV REDIS_HOST ${REDIS_HOST}

ARG JAR_FILE=/web/target/*.jar

COPY --from=build ${JAR_FILE} app.jar

ENTRYPOINT ["java", "-jar","/app.jar"]